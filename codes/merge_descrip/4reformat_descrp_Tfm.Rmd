---
title: "Check Variable and Descriptive Stats"
output:
  html_document:
    df_print: paged
---
**Tasks**
- Assign the appropriate class and labels to all covariates
- Create table1
- Check the normality of continuous variables and do the tranformations, save the datset with transformation as `birth_tfm`.

```{r message=FALSE}
rm(list = ls())
gc() 
library(dplyr)
library(data.table)
library(fastDummies)
library(tableone)
library(rtf)
```

```{r import data}
birth <- fread("/Users/shuxind/Desktop/BC_birthweight_data/birth_complt.csv",
               drop = "V1")
```

```{r}
birth$lbw <- 0
birth$lbw[birth$bwg<2500] <- 1
names(birth)
```
## Descriptive Stats
### Transform continuous to categorical
- `parity` to `firstborn`, because of some extreme large unexplained value.
- `m_wg` to `m_wg_cat` based on reference. Extreme large unexplained values exist.
```{r}
birth$firstborn <- birth$parit
#summary(birth$parit[birth$parit>7 & birth$parit<200])
#birth$parit_cat[birth$parit>7 & birth$parit<200 & !is.na(birth$parit)] <- 7
#birth$parit_cat[birth$parit>7 & birth$parit<200 & !is.na(birth$parit)] <- 7
#birth$parit_cat <- as.factor(birth$parit_cat)
birth$firstborn[birth$parit>1 & !is.na(birth$parit)] <- 0
# birth$m_wg %>% sort(decreasing = TRUE) %>% head(100)
# summary(birth$parit_cat)
plot(density(birth$m_wg, bw=1))
hist(birth$m_wg)
birth$m_wg_cat <- 0
birth$m_wg_cat[birth$m_wg<0] <- 1
birth$m_wg_cat[birth$m_wg>=0 & birth$m_wg<15] <- 2
birth$m_wg_cat[birth$m_wg>=15 & birth$m_wg<25] <- 3
birth$m_wg_cat[birth$m_wg>=25 & birth$m_wg<36] <- 4
birth$m_wg_cat[birth$m_wg>=36] <- 5
# summary(birth$m_wg_cat)
birth <- birth %>% select(-parit, -m_wg)
summary(birth)
```
### Assign the approriate class and labels to the variables
```{r reformat}
data <- birth
data$mrace[data$mrace==5] <- 4
data$year <- as.factor(data$year)
data$sex <- data$sex - 1 # 1 is girl; 0 is boy
data$m_edu <- as.factor(data$m_edu)
data$kotck <- as.factor(data$kotck)
data$m_wg_cat <- as.factor(data$m_wg_cat)
data <- fastDummies::dummy_cols(data, select_columns = "mrace")
data$bc_3090d <- with(data, (bc_90d*90-bc_30d*30)/(90-30))
data$bc_90280d <- with(data, (bc_280d*280-bc_90d*90)/(280-90))
```

```{r}
# data <- birth
# data$year <- as.factor(data$year)
# data$sex <- 
#   factor(data$sex, levels = c("1","2"),
#          labels = c("Boy", "Girl"))
# data$married <-
#   factor(data$married, levels = c("0","1"),
#          labels = c("Not married", "Married")) 
# data$mrace <-
#   factor(data$mrace, levels = c("1","2","3","4","5"),
#          labels = c("White", "Black", "Asian/Pacific Islander", "Native American", "Other"))
# data$m_edu <-
#   factor(data$m_edu, levels = c("1","2","3","4","5"),
#          labels = c("Less than high school", "High school/General Education Diploma", "Some college", "Bachelor", "Advanced degree beyond bachelor"))
# data$kotck <-
#   factor(data$kotck, levels = c("1","2","3","4"),
#          labels = c("Inadequate", "Intermediate", "Appropriate", "Appropriate plus"))
# data$pncgov <- as.logical(data$pncgov)
# data$rf_db_gest <- as.logical(data$rf_db_gest)
# data$rf_db_other <- as.logical(data$rf_db_other)
# data$rf_hbp_chronic <- as.logical(data$rf_hbp_chronic)
# data$rf_hbp_pregn <- as.logical(data$rf_hbp_pregn)
# data$rf_cervix <- as.logical(data$rf_cervix)
# data$rf_prev_4kg <- as.logical(data$rf_prev_4kg)
# data$rf_prev_sga <- as.logical(data$rf_prev_sga)
# data$med_hs_inc <- data$med_hs_inc/1000
# data$parit_cat <-   
#   factor(data$parit_cat, levels = c("0","1"),
#          labels = c("Not first born", "First born"))
# data$m_wg_cat <-
#   factor(data$m_wg_cat, levels = c("1","2","3","4","5"),
#          labels = c("<0", "[0,15)", "[15-25)", "[25-36)", "â‰¥36"))
# data$lbw <- 
#   factor(data$lbw, levels = c("0","1"),
#          labels = c("Normal birth weight", "Low birth weight"))
# 
# label(data$year) <- "Birth year"
# label(data$sex) <- "Newborn sex"
# label(data$married) <- "Maternal marital status"
# label(data$mage) <- "Maternal age (years)"
# label(data$mrace) <- "Maternal race"
# label(data$m_edu) <- "Maternal education"
# label(data$cigdpp) <- "Smoking before pregnancy (# of daily cigarettes)"
# label(data$cigddp) <- "Smoking during pregnancy (# of daily cigarettes)"
# label(data$clinega) <- "Clinical gestational age (weeks)"
# label(data$kotck) <- "The APNCU index"
# label(data$pncgov) <- "Government support for prenatal care "
# label(data$bwg) <- "Birth weight (g)"
# label(data$rf_db_gest) <- "Gestational diabetes"
# label(data$rf_db_other) <- "Maternal diabetes"
# label(data$rf_hbp_chronic) <- "Maternal chronic high blood pressure"
# label(data$rf_hbp_pregn) <- "Maternal high blood pressure during pregnancy"
# label(data$rf_cervix) <- "Maternal incompetent cervix"
# label(data$rf_prev_4kg) <- "Mother with previous infant over 4000 g "
# label(data$rf_prev_sga) <- "Mother with previous small-for-gestational-age infant"
# label(data$med_hs_inc) <- "Median household income ($1000)"
# label(data$bc_30d) <- "Average BC exposure over 30 days prior to the delivery date (&mu;g/m<sup>3</sup>)"
# label(data$bc_90d) <- "Average BC exposure over 90 days prior to delivery date (&mu;g/m<sup>3</sup>)"
# label(data$bc_280d) <- "Average BC exposure over full period pregnancy (&mu;g/m<sup>3</sup>)"
# label(data$parit_cat) <- "Parity"
# label(data$m_wg_cat) <- "Maternal weight change during pregnancy (lb.)"
```
### Export table 1
```{r}
#Table 1
listVars <- c("bwg","bc_30d",
              "bc_90d","bc_280d",
              "bc_3090d", "bc_90280d",
              "year",
              "mage","sex","married", "mrace","m_edu", "pncgov",
              "mhincome", "mhvalue", "percentPoverty",
              "cigdpp","cigddp","clinega", "firstborn", "kotck", "m_wg_cat",
              "rf_db_gest", "rf_db_other", "rf_hbp_pregn", "rf_hbp_chronic", 
              "rf_cervix", "rf_prev_4kg", "rf_prev_sga")
catVars <- c("year","sex","married","mrace","m_edu","pncgov","firstborn",
             "kotck", "m_wg_cat", "rf_db_gest", "rf_db_other", "rf_hbp_pregn", "rf_hbp_chronic", 
              "rf_cervix", "rf_prev_4kg", "rf_prev_sga")
bcVars <- c("bc_30d",
            "bc_90d","bc_280d",
            "bc_3090d", "bc_90280d")

rawtable1 <- CreateTableOne(vars = listVars, factorVars = catVars, 
                         strata = "lbw", addOverall = TRUE, test = FALSE,
                         data = data)
table1 <- print(rawtable1, nonnormal = bcVars,
                formatOption = list(decimal.mark = ".",  big.mark = ",", scientific = FALSE), contDigits = 3)

rtffile <- RTF("table1.doc")  # this can be an .rtf or a .doc
addParagraph(rtffile, "Table")
addTable(rtffile, cbind(rownames(table1), table1))
done(rtffile)


# table1(~ bwg+
#           bc_30d+bc_90d+bc_280d+
#           mage+cigdpp+cigddp+clinega+med_hs_inc+
#           sex+married+mrace+m_edu+kotck+parit_cat+m_wg_cat+
#           rf_db_gest+rf_db_other+rf_hbp_pregn+rf_hbp_chronic+rf_cervix+rf_prev_4kg+rf_prev_sga+pncgov | lbw, 
#         data=data)
```
## Check variables
- check categorical variables with multiple levels
- check normality on continuous variables
  + take log for those skewed variables
```{r check}
attach(data)

par(mfrow=c(2,3))
plot(year, main="year")
plot(mrace, main="mrace")
plot(m_edu, main="m_edu")
plot(kotck, main="kotck")
plot(m_wg_cat, main="maternal weight change")

par(mfrow=c(3,2))
hist(bwg)
hist(bc_30d)
hist(bc_90d)
hist(bc_280d)
hist(bc_3090d)
hist(bc_90280d)

par(mfrow=c(1,2))
plot(density(mage,  bw=2), main = "mage")
hist(clinega)

# cigdpp %>% sort(decreasing = TRUE) %>% head(30)
par(mfrow=c(2,2))
plot(density(cigdpp,  bw=0.5))
hist(log(cigdpp))
plot(density(log(cigdpp),  bw=0.5))
summary(cigdpp)

par(mfrow=c(2,2))
plot(density(cigddp,  bw=0.5))
hist(log(cigddp))
plot(density(log(cigddp),  bw=0.5))
summary(cigddp)

# med_hs_inc %>% sort(decreasing = TRUE) %>% head(30)
par(mfrow=c(2,2))
plot(density(mhincome, bw=1))
hist(log(mhincome))
plot(density(log(mhincome),  bw=0.5))
data$log_mhincome <- log(birth$mhincome)
summary(mhincome)

par(mfrow=c(2,2))
plot(density(mhvalue, bw=1))
hist(log(mhvalue))
plot(density(log(mhvalue),  bw=0.5))
data$log_mhvalue <- log(birth$mhvalue)
summary(mhvalue)

detach(data)
```
```{r}
# saveRDS(data, "birth_tfm.rds")
write.csv(data, "/Users/shuxind/Desktop/BC_birthweight_data/birth_final.csv")
```

