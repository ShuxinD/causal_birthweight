rf_db_gest <- c(diff(meanrf_db_gest$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_gest$mean_bd_3090d)/sd_bd_3090d, diff(meanrf_db_gest$mean_bd_90280d)/sd_bd_90280d)
meanrf_db_other <- data %>% group_by(rf_db_other) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bd_3090d=mean(bd_3090d), mean_bd_90280d=mean(bd_90280d)) %>% ungroup()
rf_db_other <- c(diff(meanrf_db_other$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_other$mean_bd_3090d)/sd_bd_3090d, diff(meanrf_db_other$mean_bd_90280d)/sd_bd_90280d)
meanrf_hbp_chronic <- data %>% group_by(rf_hbp_chronic) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bd_3090d=mean(bd_3090d), mean_bd_90280d=mean(bd_90280d)) %>% ungroup()
rf_hbp_chronic <- c(diff(meanrf_hbp_chronic$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_chronic$mean_bd_3090d)/sd_bd_3090d, diff(meanrf_hbp_chronic$mean_bd_90280d)/sd_bd_90280d)
meanrf_hbp_pregn <- data %>% group_by(rf_hbp_pregn) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bd_3090d=mean(bd_3090d), mean_bd_90280d=mean(bd_90280d)) %>% ungroup()
rf_hbp_pregn <- c(diff(meanrf_hbp_pregn$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_pregn$mean_bd_3090d)/sd_bd_3090d, diff(meanrf_hbp_pregn$mean_bd_90280d)/sd_bd_90280d)
meanrf_cervix <- data %>% group_by(rf_cervix) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bd_3090d=mean(bd_3090d), mean_bd_90280d=mean(bd_90280d)) %>% ungroup()
rf_cervix <- c(diff(meanrf_cervix$mean_bc_30d)/sd_bc_30d, diff(meanrf_cervix$mean_bd_3090d)/sd_bd_3090d, diff(meanrf_cervix$mean_bd_90280d)/sd_bd_90280d)
meanrf_prev_4kg <- data %>% group_by(rf_prev_4kg) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bd_3090d=mean(bd_3090d), mean_bd_90280d=mean(bd_90280d)) %>% ungroup()
rf_prev_4kg <- c(diff(meanrf_prev_4kg$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_4kg$mean_bd_3090d)/sd_bd_3090d, diff(meanrf_prev_4kg$mean_bd_90280d)/sd_bd_90280d)
meanrf_prev_sga <- data %>% group_by(rf_prev_sga) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bd_3090d=mean(bd_3090d), mean_bd_90280d=mean(bd_90280d)) %>% ungroup()
rf_prev_sga <- c(diff(meanrf_prev_sga$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_sga$mean_bd_3090d)/sd_bd_3090d, diff(meanrf_prev_sga$mean_bd_90280d)/sd_bd_90280d)
stdmdiff <- rbind(sex, married, pncgov, rf_db_gest, rf_db_other, rf_hbp_chronic, rf_hbp_pregn, rf_cervix, rf_prev_4kg, rf_prev_sga)
colnames(stdmdiff) <- c("stdmdiff_30d","stdmdiff_90d","stdmdiff_280d")
return(stdmdiff)
}
un_stdmdiff <- stdmdiff(birth_wt)
# un-weighted standardized difference
stdmdiff <- function(data){
sd_bc_30d <- sd(data$bc_30d)
sd_bc_3090d <- sd(data$bc_3090d)
sd_bc_90280d <- sd(data$bc_90280d)
meansex <- data %>% group_by(sex) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
sex <- c(diff(meansex$mean_bc_30d)/sd_bc_30d, diff(meansex$mean_bc_3090d)/sd_bc_3090d, diff(meansex$mean_bc_90280d)/sd_bc_90280d)
meanmarried <- data %>% group_by(married) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
married <- c(diff(meanmarried$mean_bc_30d)/sd_bc_30d, diff(meanmarried$mean_bc_3090d)/sd_bc_3090d, diff(meanmarried$mean_bc_90280d)/sd_bc_90280d)
meanpncgov <- data %>% group_by(pncgov) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
pncgov <- c(diff(meanpncgov$mean_bc_30d)/sd_bc_30d, diff(meanpncgov$mean_bc_3090d)/sd_bc_3090d, diff(meanpncgov$mean_bc_90280d)/sd_bc_90280d)
meanrf_db_gest <- data %>% group_by(rf_db_gest) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_db_gest <- c(diff(meanrf_db_gest$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_gest$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_db_gest$mean_bc_90280d)/sd_bc_90280d)
meanrf_db_other <- data %>% group_by(rf_db_other) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_db_other <- c(diff(meanrf_db_other$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_other$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_db_other$mean_bc_90280d)/sd_bc_90280d)
meanrf_hbp_chronic <- data %>% group_by(rf_hbp_chronic) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_hbp_chronic <- c(diff(meanrf_hbp_chronic$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_chronic$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_hbp_chronic$mean_bc_90280d)/sd_bc_90280d)
meanrf_hbp_pregn <- data %>% group_by(rf_hbp_pregn) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_hbp_pregn <- c(diff(meanrf_hbp_pregn$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_pregn$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_hbp_pregn$mean_bc_90280d)/sd_bc_90280d)
meanrf_cervix <- data %>% group_by(rf_cervix) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_cervix <- c(diff(meanrf_cervix$mean_bc_30d)/sd_bc_30d, diff(meanrf_cervix$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_cervix$mean_bc_90280d)/sd_bc_90280d)
meanrf_prev_4kg <- data %>% group_by(rf_prev_4kg) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_prev_4kg <- c(diff(meanrf_prev_4kg$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_4kg$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_prev_4kg$mean_bc_90280d)/sd_bc_90280d)
meanrf_prev_sga <- data %>% group_by(rf_prev_sga) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_prev_sga <- c(diff(meanrf_prev_sga$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_sga$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_prev_sga$mean_bc_90280d)/sd_bc_90280d)
stdmdiff <- rbind(sex, married, pncgov, rf_db_gest, rf_db_other, rf_hbp_chronic, rf_hbp_pregn, rf_cervix, rf_prev_4kg, rf_prev_sga)
colnames(stdmdiff) <- c("stdmdiff_30d","stdmdiff_90d","stdmdiff_280d")
return(stdmdiff)
}
un_stdmdiff <- stdmdiff(birth_wt)
View(un_stdmdiff)
View(un_stdmdiff)
?correlation
?cor
cor(birth_wt$mage, birth_wt$bc_30d)
cor(birth_wt$mage, birth_wt$bc_30d)[1]
wtd.cor(birth_wt$mage, birth_wt$bc_30d, weight = birth_wt$wt_bc_30d)
############################# 0. Setup ########################################
rm(list = ls())
gc()
library(weights)
library(radiant)
library(dplyr)
dir_input1 <- "/Users/shuxind/Desktop/BC_birthweight_data/" # change
dir_input2 <- "/Users/shuxind/Desktop/BC_birthweight_analysis/04_GPS_calc_weights/for_time_period/result/"
dir_output <- "/Users/shuxind/Desktop/BC_birthweight_analysis/05_balance_checking/result/" # change
new_plot_name <- "balance_checking_timeperiods.png"
## load data
birth <- readRDS(paste0(dir_input1, "birth_tfm.rds"))
birth <- birth %>% select(-bwg, -bc_30d)
bc <- readRDS(paste0(dir_input2, "gbm_bc_wt.rds"))
############################# 1. functions to calculated weighted corr ########
# weighted standardized difference
wtdstdmdiff <- function(data){
sd_bc_30d <- sd(data$bc_30d)
sd_bc_3090d <- sd(data$bc_3090d)
sd_bc_90280d <- sd(data$bc_90280d)
meansex <- data %>% group_by(sex) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
sex <- c(diff(meansex$mean_bc_30d)/sd_bc_30d, diff(meansex$mean_bc_3090d)/sd_bc_3090d, diff(meansex$mean_bc_90280d)/sd_bc_90280d)
meanmarried <- data %>% group_by(married) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
married <- c(diff(meanmarried$mean_bc_30d)/sd_bc_30d, diff(meanmarried$mean_bc_3090d)/sd_bc_3090d, diff(meanmarried$mean_bc_90280d)/sd_bc_90280d)
meanpncgov <- data %>% group_by(pncgov) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
pncgov <- c(diff(meanpncgov$mean_bc_30d)/sd_bc_30d, diff(meanpncgov$mean_bc_3090d)/sd_bc_3090d, diff(meanpncgov$mean_bc_90280d)/sd_bc_90280d)
meanrf_db_gest <- data %>% group_by(rf_db_gest) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
rf_db_gest <- c(diff(meanrf_db_gest$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_gest$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_db_gest$mean_bc_90280d)/sd_bc_90280d)
meanrf_db_other <- data %>% group_by(rf_db_other) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
rf_db_other <- c(diff(meanrf_db_other$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_other$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_db_other$mean_bc_90280d)/sd_bc_90280d)
meanrf_hbp_chronic <- data %>% group_by(rf_hbp_chronic) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
rf_hbp_chronic <- c(diff(meanrf_hbp_chronic$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_chronic$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_hbp_chronic$mean_bc_90280d)/sd_bc_90280d)
meanrf_hbp_pregn <- data %>% group_by(rf_hbp_pregn) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
rf_hbp_pregn <- c(diff(meanrf_hbp_pregn$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_pregn$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_hbp_pregn$mean_bc_90280d)/sd_bc_90280d)
meanrf_cervix <- data %>% group_by(rf_cervix) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
rf_cervix <- c(diff(meanrf_cervix$mean_bc_30d)/sd_bc_30d, diff(meanrf_cervix$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_cervix$mean_bc_90280d)/sd_bc_90280d)
meanrf_prev_4kg <- data %>% group_by(rf_prev_4kg) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
rf_prev_4kg <- c(diff(meanrf_prev_4kg$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_4kg$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_prev_4kg$mean_bc_90280d)/sd_bc_90280d)
meanrf_prev_sga <- data %>% group_by(rf_prev_sga) %>% summarise(mean_bc_30d=weighted.mean(bc_30d, w=wt_bc_30d), mean_bc_3090d=weighted.mean(bc_3090d, w=wt_bc_3090d), mean_bc_90280d=weighted.mean(bc_90280d, w=wt_bc_90280d)) %>% ungroup()
rf_prev_sga <- c(diff(meanrf_prev_sga$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_sga$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_prev_sga$mean_bc_90280d)/sd_bc_90280d)
wtdstdmdiff <- rbind(sex, married, pncgov, rf_db_gest, rf_db_other, rf_hbp_chronic, rf_hbp_pregn, rf_cervix, rf_prev_4kg, rf_prev_sga)
colnames(wtdstdmdiff) <- c("stdmdiff_30d","stdmdiff_3090d","stdmdiff_90280d")
return(wtdstdmdiff)
}
# weighted  correlation
wtdcorr <- function(data){
mage <- c(wtd.cor(data$mage, data$bc_30d, weight = data$wt_bc_30d)[1],wtd.cor(data$mage, data$bc_3090d, weight = data$wt_bc_3090d)[1],wtd.cor(data$mage, data$bc_90280d, weight = data$wt_bc_90280d)[1])
cigddp <- c(wtd.cor(data$cigddp, data$bc_30d, weight = data$wt_bc_30d)[1],wtd.cor(data$cigddp, data$bc_3090d, weight = data$wt_bc_3090d)[1],wtd.cor(data$cigddp, data$bc_90280d, weight = data$wt_bc_90280d)[1])
cigdpp <- c(wtd.cor(data$cigdpp, data$bc_30d, weight = data$wt_bc_30d)[1],wtd.cor(data$cigdpp, data$bc_3090d, weight = data$wt_bc_3090d)[1],wtd.cor(data$cigdpp, data$bc_90280d, weight = data$wt_bc_90280d)[1])
clinega <- c(wtd.cor(data$clinega, data$bc_30d, weight = data$wt_bc_30d)[1],wtd.cor(data$clinega, data$bc_3090d, weight = data$wt_bc_3090d)[1],wtd.cor(data$clinega, data$bc_90280d, weight = data$wt_bc_90280d)[1])
log_med_hs_inc <- c(wtd.cor(data$log_med_hs_inc, data$bc_30d, weight = data$wt_bc_30d)[1],wtd.cor(data$log_med_hs_inc, data$bc_3090d, weight = data$wt_bc_3090d)[1],wtd.cor(data$log_med_hs_inc, data$bc_90280d, weight = data$wt_bc_90280d)[1])
wtdcorr <- rbind(mage, cigddp, cigdpp, clinega, log_med_hs_inc)
colnames(wtdcorr) <- c("wtdcorr_30d", "wtdcorr_3090d", "wtdcorr_280d")
return(wtdcorr)
}
# un-weighted standardized difference
stdmdiff <- function(data){
sd_bc_30d <- sd(data$bc_30d)
sd_bc_3090d <- sd(data$bc_3090d)
sd_bc_90280d <- sd(data$bc_90280d)
meansex <- data %>% group_by(sex) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
sex <- c(diff(meansex$mean_bc_30d)/sd_bc_30d, diff(meansex$mean_bc_3090d)/sd_bc_3090d, diff(meansex$mean_bc_90280d)/sd_bc_90280d)
meanmarried <- data %>% group_by(married) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
married <- c(diff(meanmarried$mean_bc_30d)/sd_bc_30d, diff(meanmarried$mean_bc_3090d)/sd_bc_3090d, diff(meanmarried$mean_bc_90280d)/sd_bc_90280d)
meanpncgov <- data %>% group_by(pncgov) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
pncgov <- c(diff(meanpncgov$mean_bc_30d)/sd_bc_30d, diff(meanpncgov$mean_bc_3090d)/sd_bc_3090d, diff(meanpncgov$mean_bc_90280d)/sd_bc_90280d)
meanrf_db_gest <- data %>% group_by(rf_db_gest) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_db_gest <- c(diff(meanrf_db_gest$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_gest$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_db_gest$mean_bc_90280d)/sd_bc_90280d)
meanrf_db_other <- data %>% group_by(rf_db_other) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_db_other <- c(diff(meanrf_db_other$mean_bc_30d)/sd_bc_30d, diff(meanrf_db_other$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_db_other$mean_bc_90280d)/sd_bc_90280d)
meanrf_hbp_chronic <- data %>% group_by(rf_hbp_chronic) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_hbp_chronic <- c(diff(meanrf_hbp_chronic$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_chronic$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_hbp_chronic$mean_bc_90280d)/sd_bc_90280d)
meanrf_hbp_pregn <- data %>% group_by(rf_hbp_pregn) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_hbp_pregn <- c(diff(meanrf_hbp_pregn$mean_bc_30d)/sd_bc_30d, diff(meanrf_hbp_pregn$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_hbp_pregn$mean_bc_90280d)/sd_bc_90280d)
meanrf_cervix <- data %>% group_by(rf_cervix) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_cervix <- c(diff(meanrf_cervix$mean_bc_30d)/sd_bc_30d, diff(meanrf_cervix$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_cervix$mean_bc_90280d)/sd_bc_90280d)
meanrf_prev_4kg <- data %>% group_by(rf_prev_4kg) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_prev_4kg <- c(diff(meanrf_prev_4kg$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_4kg$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_prev_4kg$mean_bc_90280d)/sd_bc_90280d)
meanrf_prev_sga <- data %>% group_by(rf_prev_sga) %>% summarise(mean_bc_30d=mean(bc_30d), mean_bc_3090d=mean(bc_3090d), mean_bc_90280d=mean(bc_90280d)) %>% ungroup()
rf_prev_sga <- c(diff(meanrf_prev_sga$mean_bc_30d)/sd_bc_30d, diff(meanrf_prev_sga$mean_bc_3090d)/sd_bc_3090d, diff(meanrf_prev_sga$mean_bc_90280d)/sd_bc_90280d)
stdmdiff <- rbind(sex, married, pncgov, rf_db_gest, rf_db_other, rf_hbp_chronic, rf_hbp_pregn, rf_cervix, rf_prev_4kg, rf_prev_sga)
colnames(stdmdiff) <- c("stdmdiff_30d","stdmdiff_3090d","stdmdiff_90280d")
return(stdmdiff)
}
# un-weighted correlation
corr <- function(data){
mage <- c(cor(data$mage, data$bc_30d), cor(data$mage, data$bc_3090d), cor(data$mage, data$bc_90280d))
cigddp <- c(cor(data$cigddp, data$bc_30d), cor(data$cigddp, data$bc_3090d), cor(data$cigddp, data$bc_90280d))
cigdpp <- c(cor(data$cigdpp, data$bc_30d), cor(data$cigdpp, data$bc_3090d), cor(data$cigdpp, data$bc_90280d))
clinega <- c(cor(data$clinega, data$bc_30d), cor(data$clinega, data$bc_3090d), cor(data$clinega, data$bc_90280d))
log_med_hs_inc <- c(cor(data$log_med_hs_inc, data$bc_30d), cor(data$log_med_hs_inc, data$bc_3090d), cor(data$log_med_hs_inc, data$bc_90280d))
corr <- rbind(mage, cigddp, cigdpp, clinega, log_med_hs_inc)
colnames(corr) <- c("corr_30d", "corr_3090d", "corr_90280d")
return(corr)
}
birth_wt <- left_join(bc, birth, by = "uniqueid_yr")
remove(bc)
remove(birth)
gc()
unwtd_stdmdiff <- stdmdiff(birth_wt)
unwtd_cor <- corr(birth_wt)
# calculate balances with weighting
wtd_stdmdiff <- wtd_stdmdiff(birth_wt)
wtd_corr <- wtdcorr(birth_wt)
# calculate balances with weighting
wtd_stdmdiff <- wtdstdmdiff(birth_wt)
View(unwtd_cor)
View(unwtd_cor)
names(unwtd_cor)
colnames(unwtd_cor)
View(unwtd_stdmdiff)
View(unwtd_stdmdiff)
View(wtd_corr)
View(wtd_corr)
View(wtd_stdmdiff)
View(wtd_stdmdiff)
row.names(wtd_corr)
unwtd_corr <- corr(birth_wt)
rm(unwtd_cor)
gc()
############################# 3. draw balance plots ###########################
xvarlabel <- append(row.names(unwtd_stdmdiff),row.names(unwtd_corr))
balance_unwtd <- append(un_stdmdiff$stdmdiff_30d,un_wtdcor$wtdcor_30d)
View(unwtd_corr)
View(unwtd_corr)
balance_unwtd <- append(unwtd_stdmdiff$stdmdiff_30d,unwtd_corr$corr_30d)
unwtd_stdmdiff <- as.data.frame(unwtd_stdmdiff)
View(unwtd_stdmdiff)
View(unwtd_stdmdiff)
unwtd_corr <- as.data.frame(unwtd_corr)
wtd_stdmdiff <- as.data.frame(wtd_stdmdiff)
wtd_corr <- as.data.frame(wtd_corr)
############################# 3. draw balance plots ###########################
xvarlabel <- append(row.names(unwtd_stdmdiff),row.names(unwtd_corr))
balance_unwtd <- append(unwtd_stdmdiff$stdmdiff_30d,unwtd_corr$corr_30d)
balance_unwtd
View(wtd_corr)
View(wtd_corr)
xvar <- append(c(-1:-15),c(-1:-15))
balance <- append(balance_unwtd, balance_wtd)
series <- append(rep(4,15),rep(2,15))
plot <- as.data.frame(cbind(xvar,balance,series))
par(mai=c(1, 3.5, 0.4, 2))
plot(x=plot$balance, y=plot$xvar,
col=plot$series,pch=16,
ylim = range(c(-0,-16)),
xlim = range(c(-0.25,0.25)),
xaxs = "i", yaxs = "i",
bty="n" ,
xaxt = "n", yaxt = "n",
ylab = "", xlab="Standardized Difference/Correlation Coefficient"
)
grid(nx = 10, ny = 16, col = "lightgray", lty = 1,
lwd = par("lwd"), equilogs = TRUE)
abline(v = 0, col = 1)
axis(2, at=-1:-15, labels=label_plot,lty=0, las=1)
axis(1, at=c(-0.2,-0.15,-0.10,-0.05,0,0.05,0.10,0.15,0.2), labels=c(-0.2,-0.15,-0.10,-0.05,0,0.05,0.10,0.15,0.2),lty=0, las=1)
legend("topright",legend = c("Unweighted","Weighted"), pch = 16, col = c(4,2), bty = "n",inset=c(-0.7,0),xpd=TRUE)
balance_wtd <- append(wtd_stdmdiff$stdmdiff_30d,wtd_corr$wtdcorr_30d)
xvar <- append(c(-1:-15),c(-1:-15))
balance <- append(balance_unwtd, balance_wtd)
series <- append(rep(4,15),rep(2,15))
plot <- as.data.frame(cbind(xvar,balance,series))
par(mai=c(1, 3.5, 0.4, 2))
plot(x=plot$balance, y=plot$xvar,
col=plot$series,pch=16,
ylim = range(c(-0,-16)),
xlim = range(c(-0.25,0.25)),
xaxs = "i", yaxs = "i",
bty="n" ,
xaxt = "n", yaxt = "n",
ylab = "", xlab="Standardized Difference/Correlation Coefficient"
)
grid(nx = 10, ny = 16, col = "lightgray", lty = 1,
lwd = par("lwd"), equilogs = TRUE)
abline(v = 0, col = 1)
axis(2, at=-1:-15, labels=label_plot,lty=0, las=1)
label_plot <- c("% Female", "% Married", "% Goverment support for prenatal care",
"% Gestational diabetes", "% Maternal diabetes",
"% Maternal chronic high blood pressure",
"% Gestational high blood pressure",
"% Maternal incompetent cervix",
"% Mothers with previous infant over 4000 g",
"% Mother with previous SGA infants", "Mother's Age",
"Smoking during pregnancy", "Smoking before pregnancy",
"Clinical gestational age", "Log. median household income")
axis(2, at=-1:-15, labels=label_plot,lty=0, las=1)
axis(1, at=c(-0.2,-0.15,-0.10,-0.05,0,0.05,0.10,0.15,0.2), labels=c(-0.2,-0.15,-0.10,-0.05,0,0.05,0.10,0.15,0.2),lty=0, las=1)
legend("topright",legend = c("Unweighted","Weighted"), pch = 16, col = c(4,2), bty = "n",inset=c(-0.7,0),xpd=TRUE)
rm(list = ls())
gc()
############################# 0. Setup ########################################
rm(list = ls())
gc()
library(dplyr)
dir_input1 <- "/Users/shuxind/Desktop/BC_birthweight_data/" # change
dir_input2 <- "/Users/shuxind/Desktop/BC_birthweight_analysis/04_GPS_calc_weights/for_time_period/result/"
dir_output <- "/Users/shuxind/Desktop/BC_birthweight_analysis/06_outcome_mod/result/" # change
## load data
birth <- readRDS(paste0(dir_input1, "birth_tfm.rds"))
birth <- birth %>% select(-bwg, -bc_30d)
bc <- readRDS(paste0(dir_input2, "gbm_bc_wt.rds"))
birth_wt <- left_join(bc, birth, by = "uniqueid_yr")
remove(bc)
remove(birth)
gc()
# y as continuous birth weight
gbm_bc30d_cont <- lm(bwg ~ bc_30d, data = birth_wt, weights = wt_bc_30d)
summary(gbm_bc30d_cont)
gbm_bc3090d_cont <- lm(bwg ~ bc_3090d, data = birth_wt, weights = wt_bc_3090d)
summary(gbm_bc3090d_cont)
gbm_bc90280d_cont <- lm(bwg ~ bc_90280d, data = birth_wt, weights = wt_bc_90280d)
summary(gbm_bc90280d_cont)
# y as binary low birth weight
gbm_bc30d_binr <- glm(lbw ~ bc_30d, data = birth_wt, weights = wt_bc_30d,
family = binomial(link = "logit"))
summary(gbm_bc30d_binr)
gbm_bc3090d_binr <- glm(lbw ~ bc_3090d, data = birth_wt, weights = wt_bc_3090d,
family = binomial(link = "logit"))
summary(gbm_bc3090d_binr)
gbm_bc90280d_binr <- glm(lbw ~ bc_90280d, data = birth_wt, weights = wt_bc_90280d,
family = binomial(link = "logit"))
summary(gbm_bc90280d_binr)
iqr_bc30d <- IQR(birth_wt$bc_30d)
iqr_bc3090d <- IQR(birth_wt$bc_3090d)
iqr_bc90280d <- IQR(birth_wt$bc_90280d)
iqr_bc30d
iqr_bc3090d
iqr_bc90280d
effect <- rbind(gbm_bc30d_cont$coefficients[2]*iqr_bc30d,
gbm_bc3090d_cont$coefficients[2]*iqr_bc3090d,
gbm_bc90280d_cont$coefficients[2]*iqr_bc90280d)
halfCI <- rbind(qnorm(0.975)*summary(gbm_bc30d_cont)$coef[2,2]*iqr_bc30d,
qnorm(0.975)*summary(gbm_bc3090d_cont)$coef[2,2]*iqr_bc3090d,
qnorm(0.975)*summary(gbm_bc90280d_cont)$coef[2,2]*iqr_bc90280d)
result1 <- cbind(effect,effect-halfCI,effect+halfCI)
colnames(result1) <- c("effect for IQR", "lower CI", "upper CI")
rownames(result1) <- c("bc_30d", "bc_3090d", "bc_90280d")
print(result1)
ORs <- rbind(exp(gbm_bc30d_binr$coefficients[2]*iqr_bc30d),
exp(gbm_bc3090d_binr$coefficients[2]*iqr_bc3090d),
exp(gbm_bc90280d_binr$coefficients[2]*iqr_bc90280d))
uppCI <- rbind(exp((gbm_bc30d_binr$coefficients[2]+qnorm(0.975)*summary(gbm_bc30d_binr)$coef[2,2])*iqr_bc30d),
exp((gbm_bc3090d_binr$coefficients[2]+qnorm(0.975)*summary(gbm_bc3090d_binr)$coef[2,2])*iqr_bc3090d),
exp((gbm_bc90280d_binr$coefficients[2]+qnorm(0.975)*summary(gbm_bc90280d_binr)$coef[2,2])*iqr_bc90280d))
lowCI <- rbind(exp((gbm_bc30d_binr$coefficients[2]-qnorm(0.975)*summary(gbm_bc30d_binr)$coef[2,2])*iqr_bc30d),
exp((gbm_bc3090d_binr$coefficients[2]-qnorm(0.975)*summary(gbm_bc3090d_binr)$coef[2,2])*iqr_bc3090d),
exp((gbm_bc90280d_binr$coefficients[2]-qnorm(0.975)*summary(gbm_bc90280d_binr)$coef[2,2])*iqr_bc90280d))
result2 <- cbind(ORs, lowCI, uppCI)
colnames(result2) <- c("OR for IQR", "lower CI", "upper CI")
rownames(result2) <- c("bc_30d", "bc_3090d", "bc_90280d")
print(result2)
bcdays <- c(1:3)
diff_lowCI <- result2[,1]-result2[,2]
diff_uppCI <- result2[,3]-result2[,1]
par(mfrow=c(1,2))
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim=range(c(-7.5, 0.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
arrows(bcdays, effect-halfCI, bcdays, effect+halfCI, length=0.05, angle=90, code=3)
abline(h=0,col = 1, lty = 3)
axis(1, at=1:3, labels=c("30d","30-90d","90-280d"))
############################# 3. draw the plots ##############################
bcdays <- c(1:3)
diff_lowCI <- result2[,1]-result2[,2]
diff_uppCI <- result2[,3]-result2[,1]
par(mfrow=c(1,2))
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim=range(c(-7.5, 0.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, 0.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, 0)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, -10)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
par(mfrow=c(1,2),)
par(mfrow=c(1,2))
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, -10)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
plot(bcdays, ORs,
xlim = range(c(0.5,3.5)),
ylim=range(c(0.99, 1.08)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (b)", ylab="OR of LBW with 95% CI"
)
par("mar")
par(mfrow=c(1,2), mar=c(1,1,1,1))
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, 0.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
arrows(bcdays, effect-halfCI, bcdays, effect+halfCI, length=0.05, angle=90, code=3)
abline(h=0,col = 1, lty = 3)
axis(1, at=1:3, labels=c("30d","30-90d","90-280d"))
par(mfrow=c(1,2), mar=c(2,2,2,2))
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, 0.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
arrows(bcdays, effect-halfCI, bcdays, effect+halfCI, length=0.05, angle=90, code=3)
abline(h=0,col = 1, lty = 3)
axis(1, at=1:3, labels=c("30d","30-90d","90-280d"))
par(mfrow=c(1,2), mar=c(4,4,4,4))
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, 0.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
arrows(bcdays, effect-halfCI, bcdays, effect+halfCI, length=0.05, angle=90, code=3)
abline(h=0,col = 1, lty = 3)
axis(1, at=1:3, labels=c("30d","30-90d","90-280d"))
plot(bcdays, ORs,
xlim = range(c(0.5,3.5)),
ylim=range(c(0.99, 1.08)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (b)", ylab="OR of LBW with 95% CI"
)
arrows(bcdays, ORs-diff_lowCI, bcdays, ORs+diff_uppCI, length=0.05, angle=90, code=3)
plot(bcdays, ORs,
xlim = range(c(0.5,3.5)),
ylim=range(c(0.99, 1.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (b)", ylab="OR of LBW with 95% CI"
)
par(mfrow=c(1,2), mar=c(4,4,4,4))
plot(bcdays, effect,
xlim = range(c(0.5,3.5)),
ylim = range(c(-20, 0.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (a)", ylab="Change of birth weight with 95% CI (g)"
)
arrows(bcdays, effect-halfCI, bcdays, effect+halfCI, length=0.05, angle=90, code=3)
abline(h=0,col = 1, lty = 3)
axis(1, at=1:3, labels=c("30d","30-90d","90-280d"))
plot(bcdays, ORs,
xlim = range(c(0.5,3.5)),
ylim=range(c(0.99, 1.2)),
xaxt = "n",
pch=19, xlab="Moving averages of BC exposure \n (b)", ylab="OR of LBW with 95% CI"
)
arrows(bcdays, ORs-diff_lowCI, bcdays, ORs+diff_uppCI, length=0.05, angle=90, code=3)
abline(h=1,col = 1, lty = 3)
axis(1, at=1:3, labels=c("30d","30-90d","90-280d"))
rm(list=ls())
gc()
quit()
rm(list = ls())
gc()
library(dplyr)
library(data.table)
library(tableone)
library(rtf)
birth <- fread("/Users/shuxind/Desktop/BC_birthweight_data/birth_complt.csv",
drop = "V1")
birth$lbw <- 0
birth$lbw[birth$bwg<2500] <- 1
names(birth)
birth$firstborn <- birth$parit
#summary(birth$parit[birth$parit>7 & birth$parit<200])
#birth$parit_cat[birth$parit>7 & birth$parit<200 & !is.na(birth$parit)] <- 7
#birth$parit_cat[birth$parit>7 & birth$parit<200 & !is.na(birth$parit)] <- 7
#birth$parit_cat <- as.factor(birth$parit_cat)
birth$firstborn[birth$parit>1 & !is.na(birth$parit)] <- 0
# birth$m_wg %>% sort(decreasing = TRUE) %>% head(100)
# summary(birth$parit_cat)
plot(density(birth$m_wg, bw=1))
hist(birth$m_wg)
birth$m_wg_cat <- 0
birth$m_wg_cat[birth$m_wg<0] <- 1
birth$m_wg_cat[birth$m_wg>=0 & birth$m_wg<15] <- 2
birth$m_wg_cat[birth$m_wg>=15 & birth$m_wg<25] <- 3
birth$m_wg_cat[birth$m_wg>=25 & birth$m_wg<36] <- 4
birth$m_wg_cat[birth$m_wg>=36] <- 5
# summary(birth$m_wg_cat)
birth <- birth %>% select(-parit, -m_wg)
summary(birth)
data$race[data$race==4]
data <- birth
data$race[data$race==4]
data[data$race==4]
data$mrace[data$mrace==4]
data <- birth
data$mrace[data$mrace==5] <- 4
data$year <- as.factor(data$year)
data$sex <- data$sex - 1 # 1 is girl; 0 is boy
data$m_edu <- as.factor(data$m_edu)
data$kotck <- as.factor(data$kotck)
install.packages("fastDummies")
library(fastDummies)
results <- fastDummies::dummy_cols(data, select_columns = "mrace")
data <- birth
data$mrace[data$mrace==5] <- 4
data$year <- as.factor(data$year)
data$sex <- data$sex - 1 # 1 is girl; 0 is boy
data$m_edu <- as.factor(data$m_edu)
data$kotck <- as.factor(data$kotck)
data$m_wg_cat <- as.factor(data$m_wg_cat)
data <- fastDummies::dummy_cols(data, select_columns = "mrace")
data$bc_3090d <- with(data, (bc_90d*90-bc_30d*30)/(90-30))
data$bc_90280d <- with(data, (bc_280d*280-bc_90d*90)/(280-90))
rm(results)
gc()
###############################################################################
# Project: Causal black carbon on birth weight in MA                          #
# Code: Estimate GPS with hyperparameter we set                               #
# Input: clean birth data, BC averages, hyperparameters                       #
# Output: weights                                                             #
# Author: Shuxin Dong                                                         #
# Date: Nov 16, 2020                                                          #
###############################################################################
############################# 0. Setup ########################################
rm(list = ls())
gc()
library(dplyr)
library(data.table)
library(polycor)
dir_input <- "/Users/shuxind/Desktop/BC_birthweight_data/"
# setwd("/media/gate/Shuxin")
# dir_input <- "/media/qnap3/Shuxin/"
## load data
birth <- fread(paste0(dir_input, "birth_final.csv"),
drop = "V1")
birth$year <- as.factor(birth$year)
birth$m_edu <- as.factor(birth$m_edu)
birth$kotck <- as.factor(birth$kotck)
birth$m_wg_cat <- as.factor(birth$m_wg_cat)
library(h2o)
h2o.predict()
?h2o.predict
